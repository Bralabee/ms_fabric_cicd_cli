name: Fabric CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      config_template:
        description: 'Configuration template'
        required: true
        default: 'basic_etl'
        type: choice
        options:
        - basic_etl
        - advanced_analytics
        - data_science

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run linting
      run: |
        pip install flake8 black mypy
        echo "Running flake8..."
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        echo "Running black (check only)..."
        black --check src/
        echo "Running mypy..."
        mypy src/ --ignore-missing-imports || true
    
    - name: Security scan with Bandit
      run: |
        pip install bandit
        bandit -r src/ -ll || true
    
    - name: Validate configuration
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)/src
        python -m core.cli validate templates/blueprints/basic_etl.yaml
        python -m core.cli validate templates/blueprints/advanced_analytics.yaml
        python -m core.cli validate templates/blueprints/data_science.yaml
    
    - name: Run unit tests with coverage
      run: |
        pytest tests/ -m "not integration" -v --cov=src/ --cov-report=xml --cov-report=html
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Run integration tests
      run: |
        if [ -d tests/integration ]; then
          pytest tests/integration -m integration -v
        else
          echo "tests/integration directory not found, skipping integration tests"
        fi
    
    - name: Test Docker build
      run: |
        docker build -t usf-fabric-cli-cicd:test .

  deploy-dev:
    needs: validate
    if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Deploy to Development
      env:
        FABRIC_TOKEN: ${{ secrets.FABRIC_DEV_TOKEN }}
        TENANT_ID: ${{ secrets.TENANT_ID }}
      run: |
        # Determine config template
        CONFIG_TEMPLATE="${{ github.event.inputs.config_template || 'basic_etl' }}"
        
        # Deploy workspace
        export PYTHONPATH=$PYTHONPATH:$(pwd)/src
        python -m core.cli deploy \
          templates/blueprints/${CONFIG_TEMPLATE}.yaml \
          --env dev \
          --branch ${{ github.ref_name }} \
          --diagnose
    
    - name: Run integration tests
      env:
        FABRIC_TOKEN: ${{ secrets.FABRIC_DEV_TOKEN }}
        TENANT_ID: ${{ secrets.TENANT_ID }}
      run: |
        pytest tests/integration -m integration -v

  deploy-staging:
    needs: validate
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Deploy to Staging
      env:
        FABRIC_TOKEN: ${{ secrets.FABRIC_STAGING_TOKEN }}
        TENANT_ID: ${{ secrets.TENANT_ID }}
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)/src
        python -m core.cli deploy \
          templates/blueprints/basic_etl.yaml \
          --env staging \
          --diagnose
    
    - name: Staging validation tests
      env:
        FABRIC_TOKEN: ${{ secrets.FABRIC_STAGING_TOKEN }}
        TENANT_ID: ${{ secrets.TENANT_ID }}
      run: |
        if [ -d tests/validation ]; then
          pytest tests/validation -v
        else
          echo "tests/validation directory not found, skipping"
        fi

  deploy-prod:
    needs: deploy-staging
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Deploy to Production
      env:
        FABRIC_TOKEN: ${{ secrets.FABRIC_PROD_TOKEN }}
        TENANT_ID: ${{ secrets.TENANT_ID }}
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)/src
        python -m core.cli deploy \
          templates/blueprints/basic_etl.yaml \
          --env prod \
          --diagnose
    
    - name: Production smoke tests
      env:
        FABRIC_TOKEN: ${{ secrets.FABRIC_PROD_TOKEN }}
        TENANT_ID: ${{ secrets.TENANT_ID }}
      run: |
        if [ -d tests/smoke ]; then
          pytest tests/smoke -v
        else
          echo "tests/smoke directory not found, skipping"
        fi
    
    - name: Generate deployment report
      run: |
        echo "Deployment completed successfully" > deployment-report.txt
        echo "Timestamp: $(date)" >> deployment-report.txt
        echo "Commit: ${{ github.sha }}" >> deployment-report.txt
    
    - name: Upload deployment report
      uses: actions/upload-artifact@v3
      with:
        name: deployment-report
        path: deployment-report.txt

  feature-branch-deploy:
    needs: validate
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    environment: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Deploy feature branch workspace
      env:
        FABRIC_TOKEN: ${{ secrets.FABRIC_DEV_TOKEN }}
        TENANT_ID: ${{ secrets.TENANT_ID }}
      run: |
        # Create feature-branch specific workspace
        export PYTHONPATH=$PYTHONPATH:$(pwd)/src
        python -m core.cli deploy \
          templates/blueprints/basic_etl.yaml \
          --env dev \
          --branch ${{ github.head_ref }} \
          --force-branch-workspace \
          --diagnose
    
    - name: Comment PR with workspace info
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ðŸš€ Feature branch workspace deployed!\n\nWorkspace: `analytics-workspace-${{ github.head_ref }}`\nBranch: `${{ github.head_ref }}`\n\nYou can now test your changes in the dedicated workspace.'
          })