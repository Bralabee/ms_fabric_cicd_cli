# ─────────────────────────────────────────────────────────────────────────────
# Deploy to Fabric Pipeline — GitHub Actions Workflow
#
# Promotes content through the Fabric Deployment Pipeline stages:
#   Dev → Test → Prod
#
# Triggered either:
#   1. Automatically when a PR is merged to main (promotes Dev → Test)
#   2. Manually via workflow_dispatch (choose source/target stages)
#
# Ref: https://learn.microsoft.com/en-us/fabric/cicd/deployment-pipelines/intro-to-deployment-pipelines
# ─────────────────────────────────────────────────────────────────────────────

name: Promote via Deployment Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      pipeline_name:
        description: 'Deployment Pipeline name in Fabric'
        required: true
        type: string
      source_stage:
        description: 'Source stage to promote from'
        required: true
        default: 'Development'
        type: choice
        options:
          - Development
          - Test
      target_stage:
        description: 'Target stage to promote to'
        required: true
        default: 'Test'
        type: choice
        options:
          - Test
          - Production
      note:
        description: 'Deployment note'
        required: false
        type: string
        default: ''

# Only one promotion at a time
concurrency:
  group: fabric-promotion
  cancel-in-progress: false

jobs:
  # ─── Automated Dev → Test on push to main ─────────────────────
  auto-promote:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    env:
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      FABRIC_PIPELINE_NAME: ${{ secrets.FABRIC_PIPELINE_NAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify credentials
        run: |
          for var in AZURE_TENANT_ID AZURE_CLIENT_ID AZURE_CLIENT_SECRET; do
            if [ -z "${!var}" ]; then
              echo "::error::Required secret $var is not configured"
              exit 1
            fi
          done

          if [ -z "$FABRIC_PIPELINE_NAME" ]; then
            echo "::warning::FABRIC_PIPELINE_NAME secret not configured. Skipping promotion."
            echo "skip=true" >> $GITHUB_ENV
          else
            echo "skip=false" >> $GITHUB_ENV
          fi

      - name: Promote Dev → Test
        if: env.skip != 'true'
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/src

          python -c "
          import os, sys
          sys.path.insert(0, 'src')

          from usf_fabric_cli.services.deployment_pipeline import (
              FabricDeploymentPipelineAPI,
              DeploymentStage,
          )
          from usf_fabric_cli.utils.auth import get_fabric_token

          # Authenticate
          token = get_fabric_token()

          # Create API client
          api = FabricDeploymentPipelineAPI(access_token=token)

          # Find pipeline by name
          pipeline_name = os.environ.get('FABRIC_PIPELINE_NAME', '')
          pipeline = api.get_pipeline_by_name(pipeline_name)

          if not pipeline:
              print(f'::warning::Pipeline \"{pipeline_name}\" not found. Skipping.')
              sys.exit(0)

          pipeline_id = pipeline['id']

          # Promote Dev → Test
          result = api.promote(
              pipeline_id=pipeline_id,
              source_stage_name=DeploymentStage.DEV,
              target_stage_name=DeploymentStage.TEST,
              note=f'Auto-promote from push to main (commit: ${GITHUB_SHA:.8})',
              wait=True,
          )

          if result['success']:
              print('✅ Promotion Dev → Test succeeded')
          else:
              print(f'❌ Promotion failed: {result.get(\"error\", \"unknown\")}')
              sys.exit(1)
          "

      - name: Report promotion
        if: success() && env.skip != 'true'
        run: |
          echo "## ✅ Pipeline Promotion: Dev → Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:---|:---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Pipeline** | \`$FABRIC_PIPELINE_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Direction** | Development → Test |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | push to main |" >> $GITHUB_STEP_SUMMARY

  # ─── Manual promotion (any stage) ─────────────────────────────
  manual-promote:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: production  # Requires approval for prod deployments

    env:
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify credentials
        run: |
          for var in AZURE_TENANT_ID AZURE_CLIENT_ID AZURE_CLIENT_SECRET; do
            if [ -z "${!var}" ]; then
              echo "::error::Required secret $var is not configured"
              exit 1
            fi
          done
          echo "✅ Credentials verified"

      - name: Promote ${{ inputs.source_stage }} → ${{ inputs.target_stage }}
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/src

          python -c "
          import os, sys
          sys.path.insert(0, 'src')

          from usf_fabric_cli.services.deployment_pipeline import (
              FabricDeploymentPipelineAPI,
          )
          from usf_fabric_cli.utils.auth import get_fabric_token

          token = get_fabric_token()
          api = FabricDeploymentPipelineAPI(access_token=token)

          pipeline_name = '${{ inputs.pipeline_name }}'
          pipeline = api.get_pipeline_by_name(pipeline_name)

          if not pipeline:
              print(f'::error::Pipeline \"{pipeline_name}\" not found')
              sys.exit(1)

          result = api.promote(
              pipeline_id=pipeline['id'],
              source_stage_name='${{ inputs.source_stage }}',
              target_stage_name='${{ inputs.target_stage }}',
              note='${{ inputs.note }}' or f'Manual promotion by ${{ github.actor }}',
              wait=True,
          )

          if result['success']:
              print('✅ Promotion succeeded')
          else:
              print(f'❌ Promotion failed: {result.get(\"error\", \"unknown\")}')
              sys.exit(1)
          "

      - name: Report promotion
        if: success()
        run: |
          echo "## ✅ Pipeline Promotion: ${{ inputs.source_stage }} → ${{ inputs.target_stage }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:---|:---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Pipeline** | \`${{ inputs.pipeline_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Direction** | ${{ inputs.source_stage }} → ${{ inputs.target_stage }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Note** | ${{ inputs.note }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
