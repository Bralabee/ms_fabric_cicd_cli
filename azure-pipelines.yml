trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: fabric-credentials # Variable group in ADO Library containing CLIENT_ID, SECRET, etc.

  # ── REQUIRED: Override these in the ADO Pipeline UI ──────────────────────
  # Go to: Pipelines → Edit → Variables → Override at queue time
  # CONFIG_PATH: path to your project YAML under config/projects/
  #   Example: config/projects/acme_corp/sales_analytics.yaml
  # DEPLOY_ENV: target environment (dev, test, prod)
  #   Tip: create separate pipeline definitions per environment
  - name: CONFIG_PATH
    value: 'config/projects/YOUR_ORG/YOUR_PROJECT.yaml'
  - name: DEPLOY_ENV
    value: 'dev'

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.11'

- script: |
    python -m pip install --upgrade pip
    pip install -r requirements-dev.txt
  displayName: 'Install Dependencies'

- script: |
    # Run the deployment script using secrets from ADO variables
    export AZURE_CLIENT_ID=$(AZURE_CLIENT_ID)
    export AZURE_CLIENT_SECRET=$(AZURE_CLIENT_SECRET)
    export AZURE_TENANT_ID=$(AZURE_TENANT_ID)

    # Validate configuration first
    export PYTHONPATH=$PYTHONPATH:$(pwd)/src
    python -m usf_fabric_cli.cli validate $(CONFIG_PATH)

    # Deploy
    python -m usf_fabric_cli.cli deploy $(CONFIG_PATH) --env $(DEPLOY_ENV)
  displayName: 'Deploy to Fabric'
