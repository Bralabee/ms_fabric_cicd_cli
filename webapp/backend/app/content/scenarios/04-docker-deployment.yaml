# Docker Deployment Scenario
# Comprehensive guide with all make docker-* commands

id: docker-deployment
title: Deploy Using Docker Containers
description: |
  Master containerized deployments using all the `make docker-*` commands. Learn to build the Docker image,
  deploy workspaces in isolated containers, use interactive shells for debugging, manage multi-tenant
  deployments with different .env files, and integrate with CI/CD pipelines.
difficulty: intermediate
estimated_duration_minutes: 30
category: deployment
order: 4

prerequisites:
  - getting-started
  - project-generation
  - local-deployment

learning_outcomes:
  - "Build the Docker image with `make docker-build`"
  - "Validate configs with `make docker-validate`"
  - "Deploy workspaces with `make docker-deploy`"
  - "Use interactive shell with `make docker-shell`"
  - "Generate projects with `make docker-generate`"
  - "Initialize repos with `make docker-init-repo`"
  - "Deploy feature branches with `make docker-feature-deploy`"
  - Manage multi-tenant deployments with different ENVFILE values
  - Debug inside containers

tags:
  - docker
  - container
  - deployment
  - cicd
  - isolation
  - multi-tenant

related_scenarios:
  - local-deployment
  - feature-branch-workflows
  - git-integration
  - environment-promotion

steps:
  - id: overview
    title: Why Docker Deployment?
    type: info
    content: |
      Docker deployment provides several advantages over local Python deployment:
      
      ## Key Benefits
      
      | Benefit | Description |
      |---------|-------------|
      | **Consistency** | Same environment everywhere (dev laptop, CI/CD, production) |
      | **Isolation** | No dependency conflicts with other Python projects |
      | **Portability** | Works on any machine with Docker installed |
      | **Security** | Credentials passed via env-file, not stored in container |
      | **Multi-tenant** | Easy switching between client configurations via ENVFILE |
      | **CI/CD Ready** | Identical behavior in GitHub Actions, Azure DevOps, etc. |
      
      ## All Docker Commands
      
      | Command | Purpose |
      |---------|---------|
      | `make docker-build` | Build the Docker image |
      | `make docker-shell ENVFILE=.env` | Interactive debugging shell |
      | `make docker-diagnose ENVFILE=.env` | Run preflight checks |
      | `make docker-validate config=... ENVFILE=.env` | Validate configuration |
      | `make docker-deploy config=... env=dev ENVFILE=.env` | Deploy workspace |
      | `make docker-destroy config=... ENVFILE=.env` | Destroy workspace |
      | `make docker-generate org="..." project="..." template="..."` | Generate config |
      | `make docker-init-repo org="..." project="..." repo="..."` | Initialize ADO repo |
      | `make docker-feature-deploy config=... env=dev branch=feature/x` | Feature branch deploy |
    tips:
      - Docker deployment is recommended for production CI/CD use
      - "All `docker-*` commands require the image built first"

  - id: prerequisites
    title: "Step 1: Verify Docker Prerequisites"
    type: checkpoint
    content: |
      Before starting, ensure Docker is installed and running on your machine.
      
      ## Requirements
      
      | Component | Minimum Version | Check Command |
      |-----------|-----------------|---------------|
      | Docker Engine | 20.x+ | `docker --version` |
      | Docker Compose | 2.x+ | `docker compose version` |
      | Docker daemon | Running | `docker ps` |
    code:
      language: bash
      content: |
        # Check Docker version
        docker --version
        
        # Check Docker daemon is running
        docker ps
        
        # Check Docker Compose
        docker compose version
        
        # Check available disk space (image needs ~500MB)
        df -h
    expected_output: |
      Docker version 24.0.7, build afdd53b
      
      CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
      
      Docker Compose version v2.24.5
      
      Filesystem      Size  Used Avail Use% Mounted on
      /dev/sda1       100G   45G   55G  45% /
    checkpoint_question: Is Docker installed and the daemon running?
    warnings:
      - "If `docker ps` fails, start Docker Desktop or the daemon"
      - "On Linux, you may need `sudo` or add your user to the `docker` group"

  - id: build-image
    title: "Step 2: Build the Docker Image"
    type: command
    content: |
      Build the Docker image that includes everything needed for deployments:
      
      ## What's in the Image
      
      | Component | Description |
      |-----------|-------------|
      | Python 3.11 | Runtime environment |
      | Framework code | All `src/core/` modules and scripts |
      | Dependencies | typer, rich, pyyaml, jinja2, azure-identity |
      | Fabric CLI | Official Microsoft Fabric CLI (`fab` command) |
      | Non-root user | Security hardening |
    code:
      language: bash
      content: |
        # Build using Makefile (RECOMMENDED)
        make docker-build
        
        # OR build manually with Docker
        docker build -t fabric-cli-cicd .
        
        # Verify the image was created
        docker images | grep fabric-cli-cicd
    expected_output: |
      [+] Building 45.2s (12/12) FINISHED
       => [internal] load build definition from Dockerfile          0.0s
       => [internal] load .dockerignore                             0.0s
       => [internal] load metadata for docker.io/library/python     0.5s
       => [1/8] FROM docker.io/library/python:3.11-slim            10.2s
       => [2/8] RUN apt-get update && apt-get install -y git        5.3s
       => [3/8] WORKDIR /app                                        0.1s
       => [4/8] COPY requirements.txt .                             0.1s
       => [5/8] RUN pip install --no-cache-dir -r requirements.txt  20.5s
       => [6/8] COPY . .                                            0.3s
       => [7/8] RUN pip install -e .                                3.2s
       => [8/8] RUN pip install https://github.com/.../fabric-sdk   5.0s
       => exporting to image                                        1.2s
       => => naming to docker.io/library/fabric-cli-cicd            0.0s
      
      REPOSITORY        TAG       IMAGE ID       CREATED          SIZE
      fabric-cli-cicd   latest    abc123def456   30 seconds ago   512MB
    tips:
      - First build takes 2-5 minutes to install all dependencies
      - Subsequent builds use cached layers and are much faster
      - Rebuild after updating requirements.txt or Dockerfile

  - id: verify-cli
    title: "Step 3: Verify Installation in Container"
    type: command
    content: |
      Test that everything is correctly installed inside the container:
    code:
      language: bash
      content: |
        # Check Fabric CLI version
        docker run --rm fabric-cli-cicd fab --version
        
        # Check Python version
        docker run --rm fabric-cli-cicd python --version
        
        # Check framework CLI
        docker run --rm fabric-cli-cicd fabric-cicd --help
        
        # Test Python imports
        docker run --rm fabric-cli-cicd python -c "import typer; import rich; import yaml; print('All imports OK')"
    expected_output: |
      fab version 0.1.5
      
      Python 3.11.9
      
      Usage: fabric-cicd [OPTIONS] COMMAND [ARGS]...
      
        Fabric CLI CI/CD - Enterprise Deployment Framework
      
      Options:
        --version  Show version
        --help     Show this message and exit.
      
      Commands:
        deploy    Deploy Fabric workspace from configuration file.
        destroy   Destroy Fabric workspace and all items.
        diagnose  Run preflight diagnostics.
        validate  Validate configuration file syntax and structure.
      
      All imports OK
    tips:
      - "`fab` is the official Microsoft Fabric CLI"
      - "`fabric-cicd` is the framework's orchestration CLI"

  - id: docker-diagnose
    title: "Step 4: Run Preflight Diagnostics"
    type: command
    content: |
      Run preflight checks inside the container to verify credentials and connectivity:
    code:
      language: bash
      content: |
        # Run diagnostics using Makefile
        make docker-diagnose ENVFILE=.env
        
        # OR manually
        docker run --rm \
          --env-file .env \
          fabric-cli-cicd \
          python scripts/preflight_check.py
    expected_output: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘            Fabric CLI CI/CD Preflight Check                  â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      Checking Fabric CLI...
      âœ“ Fabric CLI installed (version 0.1.5)
      
      Checking Credentials...
      âœ“ AZURE_CLIENT_ID loaded
      âœ“ AZURE_CLIENT_SECRET loaded
      âœ“ AZURE_TENANT_ID loaded
      âœ“ FABRIC_CAPACITY_ID loaded
      
      Checking Authentication...
      âœ“ Token generation successful
      
      Checking Fabric API...
      âœ“ Fabric API accessible
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âœ… All preflight checks passed!
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    tips:
      - Always run diagnose before your first Docker deployment
      - "`ENVFILE=.env` tells Make which credentials file to use"

  - id: docker-validate
    title: "Step 5: Validate Configuration"
    type: command
    content: |
      Validate your configuration inside the container before deploying:
      
      ## Volume Mounts
      
      The command mounts these directories:
      - "`./config:/app/config` - Your configuration files"
      - "`--env-file .env` - Your credentials"
    code:
      language: bash
      content: |
        # Validate using Makefile (RECOMMENDED)
        make docker-validate config=config/projects/acme_corp/sales_analytics.yaml ENVFILE=.env
        
        # OR manually with docker run
        docker run --rm \
          --env-file .env \
          -v "$(pwd)/config:/app/config:ro" \
          fabric-cli-cicd \
          fabric-cicd validate config/projects/acme_corp/sales_analytics.yaml
    expected_output: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘              Configuration Validation                        â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      Loading: config/projects/acme_corp/sales_analytics.yaml
      
      âœ“ YAML syntax valid
      âœ“ Required fields present
      âœ“ Environment variables resolved (4 variables)
      âœ“ Jinja2 template syntax valid
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âœ… Configuration is valid!
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    tips:
      - "The `:ro` flag mounts config as read-only for security"
      - Fix validation errors before deploying

  - id: docker-deploy
    title: "Step 6: Deploy Workspace"
    type: command
    content: |
      Deploy your workspace using the containerized environment:
      
      ## Volume Mounts
      
      | Mount | Purpose |
      |-------|---------|
      | `./config:/app/config` | Configuration files |
      | `./audit_logs:/app/audit_logs` | Persist audit logs |
    code:
      language: bash
      content: |
        # Deploy using Makefile (RECOMMENDED)
        make docker-deploy config=config/projects/acme_corp/sales_analytics.yaml env=dev ENVFILE=.env
        
        # OR manually
        docker run --rm \
          --env-file .env \
          -v "$(pwd)/config:/app/config:ro" \
          -v "$(pwd)/audit_logs:/app/audit_logs" \
          fabric-cli-cicd \
          fabric-cicd deploy config/projects/acme_corp/sales_analytics.yaml --env dev
    expected_output: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘               Fabric Workspace Deployment                    â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      Configuration: config/projects/acme_corp/sales_analytics.yaml
      Environment: dev
      
      âœ“ Authenticated as Service Principal
      âœ“ Workspace 'acme-sales-analytics-dev' created
      âœ“ Folder '01_Bronze' created
      âœ“ Lakehouse 'sales_raw' created
      ...
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âœ… Deployment completed successfully!
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    tips:
      - "Mount `audit_logs/` to persist deployment records on your host"
      - Container runs as non-root user for security

  - id: docker-destroy
    title: "Step 7: Destroy Workspace"
    type: command
    content: |
      Destroy a workspace using Docker:
    code:
      language: bash
      content: |
        # Destroy using Makefile (requires confirmation)
        make docker-destroy config=config/projects/acme_corp/sales_analytics.yaml env=dev ENVFILE=.env
        
        # OR manually
        docker run -it --rm \
          --env-file .env \
          -v "$(pwd)/config:/app/config:ro" \
          fabric-cli-cicd \
          fabric-cicd destroy config/projects/acme_corp/sales_analytics.yaml --env dev
    expected_output: |
      âš ï¸  WORKSPACE DESTRUCTION
      
      Workspace: acme-sales-analytics-dev
      
      Type 'yes' to confirm: yes
      
      âœ“ Workspace destroyed
    warnings:
      - This permanently deletes the workspace and all data
      - "Use `-it` flag for interactive confirmation prompt"

  - id: docker-shell
    title: "Step 8: Interactive Debugging Shell"
    type: command
    content: |
      Need to debug issues? Open an interactive shell inside the container:
      
      This is invaluable for:
      - Testing credential loading
      - Exploring the container filesystem
      - Running ad-hoc commands
      - Debugging API connectivity
    code:
      language: bash
      content: |
        # Open interactive shell using Makefile
        make docker-shell ENVFILE=.env
        
        # OR manually
        docker run -it --rm \
          --env-file .env \
          -v "$(pwd)/config:/app/config" \
          -v "$(pwd)/scripts:/app/scripts:ro" \
          --entrypoint /bin/bash \
          fabric-cli-cicd
        
        # Inside the container, you can run:
        # fab --version
        # python scripts/preflight_check.py
        # python scripts/utilities/list_workspaces.py
        # fabric-cicd diagnose
    expected_output: |
      # You'll get a bash prompt inside the container:
      appuser@abc123:/app$ 
      
      # Run commands:
      appuser@abc123:/app$ fab --version
      fab version 0.1.5
      
      appuser@abc123:/app$ python scripts/utilities/list_workspaces.py
      Found 3 workspaces:
      - sales-analytics-dev
      - sales-analytics-prod
      - marketing-reports
      
      appuser@abc123:/app$ exit
    tips:
      - Use this to debug authentication or path issues
      - "Type `exit` to leave the container"
      - "All mounted volumes are accessible at `/app/`"

  - id: docker-generate
    title: "Step 9: Generate Projects in Docker"
    type: command
    content: |
      Generate project configurations from inside the container:
    code:
      language: bash
      content: |
        # Generate using Makefile
        make docker-generate org="Contoso Inc" project="Finance Analytics" template="basic_etl"
        
        # OR manually
        docker run --rm \
          -v "$(pwd)/config:/app/config" \
          fabric-cli-cicd \
          python scripts/generate_project.py "Contoso Inc" "Finance Analytics" --template basic_etl
        
        # Verify the generated file
        ls config/projects/contoso_inc/
        cat config/projects/contoso_inc/finance_analytics.yaml
    expected_output: |
      âœ“ Configuration generated: config/projects/contoso_inc/finance_analytics.yaml
      
      Template: basic_etl
      Organization: Contoso Inc â†’ contoso_inc
      Project: Finance Analytics â†’ finance_analytics
      
      # ls output:
      finance_analytics.yaml
    tips:
      - Generated files persist on your host because the directory is mounted
      - You can then validate and deploy the generated config

  - id: docker-init-repo
    title: "Step 10: Initialize ADO Repository"
    type: command
    content: |
      Initialize Azure DevOps repositories from within Docker:
    code:
      language: bash
      content: |
        # Initialize repo using Makefile
        make docker-init-repo org="acme-org" project="FabricProjects" repo="sales-analytics"
        
        # OR manually
        docker run --rm \
          --env-file .env \
          fabric-cli-cicd \
          python scripts/utilities/init_ado_repo.py \
            --organization "acme-org" \
            --project "FabricProjects" \
            --repository "sales-analytics"
    expected_output: |
      Initializing Azure DevOps repository...
      
      Organization: acme-org
      Project: FabricProjects
      Repository: sales-analytics
      
      âœ“ Repository 'sales-analytics' created
      âœ“ Branch 'main' created
      âœ“ Initial README committed
      
      Repository URL: https://dev.azure.com/acme-org/FabricProjects/_git/sales-analytics
    tips:
      - "Requires `AZURE_DEVOPS_PAT` in your .env file"
      - The PAT needs Repository Create permissions

  - id: multi-tenant
    title: "Multi-Tenant Deployments"
    type: info
    content: |
      The Docker approach excels at multi-tenant scenarios where you manage 
      multiple clients with different credentials.
      
      ## Strategy: Separate .env Files
      
      Create a separate `.env` file for each client/tenant:
      
      ```
      .env                # Default/dev credentials
      .env.client_a       # Client A credentials
      .env.client_b       # Client B credentials
      .env.prod           # Production credentials
      ```
      
      ## Key Parameter: ENVFILE
      
      The `ENVFILE` parameter tells Make which credential file to use:
    code:
      language: bash
      content: |
        # Deploy for Client A
        make docker-deploy \
          config=config/projects/client_a/analytics.yaml \
          env=dev \
          ENVFILE=.env.client_a
        
        # Deploy for Client B
        make docker-deploy \
          config=config/projects/client_b/analytics.yaml \
          env=dev \
          ENVFILE=.env.client_b
        
        # Production deployment with production credentials
        make docker-deploy \
          config=config/projects/acme/sales.yaml \
          env=prod \
          ENVFILE=.env.prod
    tips:
      - "Store client `.env` files securely (encrypted, Azure Key Vault, etc.)"
      - "Add all `.env.*` files to `.gitignore`"
      - In CI/CD, inject credentials from secret management systems
    warnings:
      - "Never commit `.env.*` files to version control"
      - Rotate client credentials regularly

  - id: cicd-example
    title: "CI/CD Pipeline Example"
    type: info
    content: |
      Here's how to use Docker deployment in a CI/CD pipeline:
      
      ## GitHub Actions Example
    code:
      language: yaml
      filename: .github/workflows/deploy.yml
      content: |
        name: Deploy Fabric Workspace
        
        on:
          push:
            branches: [main]
          workflow_dispatch:
            inputs:
              environment:
                description: 'Target environment'
                required: true
                default: 'dev'
                type: choice
                options: [dev, staging, prod]
        
        jobs:
          deploy:
            runs-on: ubuntu-latest
            steps:
              - uses: actions/checkout@v4
              
              - name: Build Docker image
                run: make docker-build
              
              - name: Create .env file from secrets
                run: |
                  cat > .env << EOF
                  AZURE_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}
                  AZURE_CLIENT_SECRET=${{ secrets.AZURE_CLIENT_SECRET }}
                  AZURE_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}
                  FABRIC_CAPACITY_ID=${{ secrets.FABRIC_CAPACITY_ID }}
                  EOF
              
              - name: Validate configuration
                run: make docker-validate config=config/projects/acme/sales.yaml ENVFILE=.env
              
              - name: Deploy to ${{ github.event.inputs.environment || 'dev' }}
                run: |
                  make docker-deploy \
                    config=config/projects/acme/sales.yaml \
                    env=${{ github.event.inputs.environment || 'dev' }} \
                    ENVFILE=.env
              
              - name: Upload audit logs
                uses: actions/upload-artifact@v4
                with:
                  name: audit-logs
                  path: audit_logs/
    tips:
      - Store credentials in GitHub Secrets, not in the workflow file
      - Consider adding approval gates for production deployments
      - Upload audit logs as artifacts for compliance

  - id: next-steps
    title: "ðŸŽ‰ Docker Mastery Complete - Next Steps"
    type: info
    content: |
      You've mastered Docker deployments!
      
      ## What You've Accomplished
      
      - "âœ… Built the Docker image with `make docker-build`"
      - "âœ… Ran diagnostics with `make docker-diagnose`"
      - "âœ… Validated configs with `make docker-validate`"
      - "âœ… Deployed workspaces with `make docker-deploy`"
      - "âœ… Used interactive shell with `make docker-shell`"
      - "âœ… Generated projects with `make docker-generate`"
      - "âœ… Initialized repos with `make docker-init-repo`"
      - âœ… Understand multi-tenant deployments with ENVFILE
      - âœ… Have a CI/CD pipeline template
      
      ## Complete Docker Command Reference
      
      | Command | Purpose |
      |---------|---------|
      | `make docker-build` | Build image |
      | `make docker-shell ENVFILE=.env` | Interactive debugging |
      | `make docker-diagnose ENVFILE=.env` | Preflight checks |
      | `make docker-validate config=... ENVFILE=.env` | Validate config |
      | `make docker-deploy config=... env=dev ENVFILE=.env` | Deploy |
      | `make docker-destroy config=... ENVFILE=.env` | Destroy |
      | `make docker-generate org="..." project="..." template="..."` | Generate |
      | `make docker-init-repo org="..." project="..." repo="..."` | Init repo |
      | `make docker-feature-deploy config=... env=dev branch=feature/x` | Feature branch |
      
      ## Recommended Next Steps
      
      1. **Next:** [Feature Branch Workflows](#feature-branch-workflows) - Isolated development
      2. **Then:** [Git Integration](#git-integration) - Connect to version control
      3. **Reference:** [Troubleshooting](#troubleshooting) - Debug common issues
