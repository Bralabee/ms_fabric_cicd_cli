# Git Integration Scenario
# Comprehensive guide to connecting Fabric workspaces to version control

id: git-integration
title: Git Integration (Azure DevOps & GitHub)
description: |
  Master Git integration for Microsoft Fabric workspaces. Learn to use
  `init_ado_repo.py` for repository initialization, `debug_ado_access.py` for
  troubleshooting connectivity, `make docker-init-repo` for containerized setup,
  and configure workspace YAML for automatic Git connections during deployment.
difficulty: intermediate
estimated_duration_minutes: 25
category: integration
order: 6

prerequisites:
  - getting-started
  - local-deployment

learning_outcomes:
  - "Initialize Azure DevOps repositories with `python -m usf_fabric_cli.scripts.admin.utilities.init_ado_repo`"
  - "Debug ADO connectivity with `python -m usf_fabric_cli.scripts.admin.utilities.debug_ado_access`"
  - "Use Docker for repo initialization with `make docker-init-repo`"
  - "Configure `git_repo` and `git_branch` in workspace YAML"
  - Understand Git sync behavior in Fabric workspaces
  - Troubleshoot common Git integration errors
  - Connect to GitHub repositories

tags:
  - git
  - azure-devops
  - github
  - version-control
  - integration
  - init-ado-repo
  - debug-ado-access

related_scenarios:
  - feature-branch-workflows
  - docker-deployment
  - troubleshooting

steps:
  - id: overview
    title: Why Git Integration?
    type: info
    content: |
      Git integration connects Fabric workspaces to version control repositories,
      enabling true Infrastructure as Code (IaC) practices.

      ## Supported Providers

      | Provider | Authentication | Script |
      |----------|----------------|--------|
      | **Azure DevOps** | Service Principal + PAT | `init_ado_repo.py` |
      | **GitHub** | Personal Access Token | Manual setup |

      ## Key Benefits

      | Benefit | Description |
      |---------|-------------|
      | **Version Control** | Track all changes to Fabric artifacts |
      | **Code Review** | PR-based approval workflows |
      | **Rollback** | Restore previous versions easily |
      | **Environment Promotion** | dev â†’ staging â†’ prod via Git branches |
      | **Collaboration** | Multiple developers working safely |
      | **Audit Trail** | Complete history of all changes |

      ## How It Works

      1. You configure `git_repo` and `git_branch` in your YAML
      2. During deployment, framework connects workspace to repo
      3. Workspace artifacts sync to Git repository
      4. Changes made in Fabric portal sync back to Git
      5. Changes pushed to Git sync to workspace

      ## Commands Overview

      | Purpose | Command |
      |---------|---------|
      | Initialize ADO repo | `python -m usf_fabric_cli.scripts.admin.utilities.init_ado_repo` |
      | Docker repo init | `make docker-init-repo org="..." project="..." repo="..."` |
      | Debug ADO access | `python -m usf_fabric_cli.scripts.admin.utilities.debug_ado_access` |
    tips:
      - Git integration requires a repository with at least one commit
      - The framework uses REST API because Fabric CLI doesn't support Git yet

  - id: prerequisites
    title: "Step 1: Check Prerequisites"
    type: checkpoint
    content: |
      Before configuring Git integration, ensure you have the required permissions:

      ## Azure DevOps Requirements

      | Requirement | How to Verify |
      |-------------|---------------|
      | Service Principal has **Basic** access level | ADO Organization Settings â†’ Users |
      | SP is **Contributor** in ADO Project | Project Settings â†’ Permissions |
      | PAT with `Code (Read & Write)` scope | Personal Access Tokens |
      | Repository exists (or will be created) | Azure Repos |

      ## GitHub Requirements

      | Requirement | How to Verify |
      |-------------|---------------|
      | PAT with `repo` scope | Settings â†’ Developer Settings â†’ PATs |
      | Repository exists | github.com/org/repo |

      ## Fabric Tenant Requirements

      - "Allow service principals to use Git integration" must be **enabled**
      - Location: Admin Portal â†’ Tenant Settings â†’ Git integration
    code:
      language: bash
      content: |
        # Check that PAT is configured in .env
        grep -E "AZURE_DEVOPS_PAT|GITHUB_TOKEN" .env

        # Expected output for ADO:
        # AZURE_DEVOPS_PAT=xxxxxxxxxxxxxxxxxxxx

        # Expected output for GitHub:
        # GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxx
    expected_output: |
      AZURE_DEVOPS_PAT=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    checkpoint_question: Do you have the required PAT and permissions configured?
    warnings:
      - Missing PAT will cause Git integration to fail silently
      - SP needs Basic access level, not Stakeholder (which is read-only)

  - id: debug-ado-access
    title: "Step 2: Debug ADO Access"
    type: command
    content: |
      Before initializing a repository, verify your Azure DevOps access:

      ## Why Debug First?

      The most common Git integration failures are permission-related. This script
      validates connectivity before you waste time on deployment.
    code:
      language: bash
      content: |
        # Debug Azure DevOps access
        python -m usf_fabric_cli.scripts.admin.utilities.debug_ado_access \
          --organization "acme-corp" \
          --project "FabricProjects"

        # This checks:
        # 1. PAT authentication works
        # 2. Organization is accessible
        # 3. Project is accessible
        # 4. Service Principal has correct permissions
    expected_output: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘            Azure DevOps Access Debug                         â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      Organization: acme-corp
      Project: FabricProjects

      Checking PAT authentication...
      âœ“ PAT authentication successful

      Checking organization access...
      âœ“ Organization 'acme-corp' accessible

      Checking project access...
      âœ“ Project 'FabricProjects' accessible

      Checking service principal permissions...
      âœ“ Service Principal access level: Basic
      âœ“ Project role: Contributor

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âœ… All Azure DevOps access checks passed!
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    tips:
      - Run this BEFORE initializing repositories
      - If checks fail, fix permissions before proceeding

  - id: init-repo-local
    title: "Step 3A: Initialize ADO Repository (Local)"
    type: command
    content: |
      Fabric Git integration requires a repository with **at least one commit**.
      Empty repositories (0 branches) will fail.

      ## Why Initialize?

      - Azure DevOps creates repositories with 0 branches by default
      - Fabric cannot connect to repositories with no branches
      - This script creates an initial commit with a README
    code:
      language: bash
      content: |
        # Initialize a new Azure DevOps repository
        python -m usf_fabric_cli.scripts.admin.utilities.init_ado_repo \
          --organization "acme-corp" \
          --project "FabricProjects" \
          --repository "sales-analytics-repo" \
          --branch "main"

        # Parameters:
        #   --organization: Your ADO organization name
        #   --project: Your ADO project name
        #   --repository: Repository name to create/initialize
        #   --branch: Initial branch name (default: main)
    expected_output: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘            Azure DevOps Repository Initialization            â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      Organization: acme-corp
      Project: FabricProjects
      Repository: sales-analytics-repo
      Branch: main

      Creating repository...
      âœ“ Repository 'sales-analytics-repo' created (or already exists)

      Creating initial commit...
      âœ“ Branch 'main' created
      âœ“ Initial README.md committed

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âœ… Repository ready for Fabric Git integration!

      Repository URL: https://dev.azure.com/acme-corp/FabricProjects/_git/sales-analytics-repo
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    tips:
      - Run this ONCE per repository before first deployment
      - Existing repositories with commits don't need initialization
      - The script is idempotent - safe to run multiple times

  - id: init-repo-docker
    title: "Step 3B: Initialize ADO Repository (Docker)"
    type: command
    content: |
      For containerized workflows, use the Docker command:
    code:
      language: bash
      content: |
        # Initialize repo using Docker (requires docker-build first)
        make docker-init-repo \
          org="acme-corp" \
          project="FabricProjects" \
          repo="sales-analytics-repo"

        # With custom env file
        make docker-init-repo \
          org="acme-corp" \
          project="FabricProjects" \
          repo="sales-analytics-repo" \
          ENVFILE=.env.prod
    expected_output: |
      âœ“ Repository 'sales-analytics-repo' initialized
      âœ“ Branch 'main' created
      âœ“ Initial README committed

      Repository URL: https://dev.azure.com/acme-corp/FabricProjects/_git/sales-analytics-repo
    tips:
      - "Docker image must be built first (`make docker-build`)"
      - "Uses ENVFILE for credentials (default: .env)"

  - id: configure-yaml
    title: "Step 4: Configure Git in Workspace YAML"
    type: config
    content: |
      Add Git configuration to your workspace YAML file:

      ## Key Fields

      | Field | Required | Description |
      |-------|----------|-------------|
      | `git_repo` | âœ“ | Full URL to the repository |
      | `git_branch` | âœ“ | Branch to connect to |
      | `git_directory` | Optional | Subdirectory in repo for Fabric files |
    code:
      language: yaml
      filename: config/projects/acme_corp/sales_analytics.yaml
      content: |
        workspace:
          name: "acme-sales-analytics"
          display_name: "Acme Sales Analytics [{{ env }}]"
          capacity_id: "${FABRIC_CAPACITY_ID}"

          # Git Integration Configuration
          git_repo: "https://dev.azure.com/acme-corp/FabricProjects/_git/sales-analytics-repo"
          git_branch: "main"
          git_directory: "/fabric"  # Optional: store artifacts in a subdirectory

        # Rest of configuration...
        lakehouses:
          - name: "sales_raw"
            folder: "01_Bronze"

        # ...

        # Environment-specific Git branches
        environments:
          dev:
            workspace:
              git_branch: "develop"
          staging:
            workspace:
              git_branch: "staging"
          prod:
            workspace:
              git_branch: "main"
    tips:
      - "Use environment variables for flexibility: `git_repo: \"${GIT_REPO_URL}\"`"
      - Use environment overrides for branch-per-environment strategy
      - "The `git_directory` is useful when repo has non-Fabric content too"

  - id: deploy-with-git
    title: "Step 5: Deploy with Git Integration"
    type: command
    content: |
      When you deploy a workspace with Git configuration, the framework will:

      1. Create the workspace
      2. Create folders and items
      3. Add principals
      4. **Connect workspace to Git repository**
      5. **Perform initial sync to commit workspace contents**
    code:
      language: bash
      content: |
        # Deploy workspace with Git integration
        make deploy config=config/projects/acme_corp/sales_analytics.yaml env=dev

        # OR using CLI directly
        fabric-cicd deploy config/projects/acme_corp/sales_analytics.yaml --env dev

        # OR using Docker
        make docker-deploy config=config/projects/acme_corp/sales_analytics.yaml env=dev ENVFILE=.env
    expected_output: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘               Fabric Workspace Deployment                    â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      Configuration: config/projects/acme_corp/sales_analytics.yaml
      Environment: dev

      Creating workspace...
      âœ“ Workspace 'acme-sales-analytics-dev' created

      Creating folders...
      âœ“ Folder '01_Bronze' created
      âœ“ Folder '02_Silver' created

      Creating items...
      âœ“ Lakehouse 'sales_raw' created
      âœ“ Notebook 'transform_data' created

      Adding principals...
      âœ“ Principal 'dev-team@acme.com' added with 'Member' role

      Connecting Git...
      âœ“ Git integration: Connecting to Azure DevOps...
      âœ“ Git integration: Connected to 'main' branch
      âœ“ Git sync: Initial commit created

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âœ… Deployment completed successfully!
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    tips:
      - First deployment creates an initial commit with workspace contents
      - Check the repository after deployment to see Fabric artifact definitions

  - id: verify-connection
    title: "Step 6: Verify Git Connection"
    type: checkpoint
    content: |
      Verify the Git connection in multiple ways:

      ## In Fabric Portal

      1. Navigate to your workspace in [app.fabric.microsoft.com](https://app.fabric.microsoft.com)
      2. Look for the **Source Control** icon in the toolbar
      3. Should show "Connected to main" (or your configured branch)

      ## Via Git Clone
    code:
      language: bash
      content: |
        # Clone the repository to inspect Fabric artifacts
        git clone https://dev.azure.com/acme-corp/FabricProjects/_git/sales-analytics-repo temp_repo
        cd temp_repo

        # List the structure
        ls -la

        # You should see Fabric artifact definitions:
        # - .pbi/ folder (for semantic models)
        # - *.json files (item definitions)
        # - Notebook/ folders (with notebook content)

        # View the commit history
        git log --oneline

        # Clean up
        cd .. && rm -rf temp_repo
    expected_output: |
      Cloning into 'temp_repo'...
      remote: Azure Repos
      remote: Found 15 objects to send.
      Receiving objects: 100% (15/15), done.

      total 4
      drwxr-xr-x  5 user user 4096 Jan 15 10:00 .
      drwxr-xr-x 10 user user 4096 Jan 15 10:00 ..
      drwxr-xr-x  8 user user 4096 Jan 15 10:00 .git
      -rw-r--r--  1 user user  256 Jan 15 10:00 README.md
      drwxr-xr-x  2 user user 4096 Jan 15 10:00 fabric

      # In fabric/ directory:
      -rw-r--r--  1 user user 1024 Jan 15 10:00 sales_raw.Lakehouse
      -rw-r--r--  1 user user 2048 Jan 15 10:00 transform_data.Notebook

      # Git log:
      abc1234 Initial commit from Fabric workspace
      def5678 Initial README
    checkpoint_question: Does your workspace show "Connected" in Source Control and can you see artifacts in the Git repository?

  - id: common-errors
    title: "Troubleshooting: Common Git Errors"
    type: info
    content: |
      ## Error 1: "Repository is empty"

      | Symptom | Cause | Solution |
      |---------|-------|----------|
      | Git connection fails | Repository has 0 branches | Run `init_ado_repo.py` to create initial commit |

      ```bash
      # Fix:
      python -m usf_fabric_cli.scripts.admin.utilities.init_ado_repo \
        --organization "acme-corp" \
        --project "FabricProjects" \
        --repository "sales-analytics-repo"
      ```

      ## Error 2: "Access denied" / "Unauthorized"

      | Symptom | Cause | Solution |
      |---------|-------|----------|
      | 401/403 errors | PAT expired or wrong scope | Generate new PAT with `Code (Read & Write)` |
      | "User not found" | SP not in ADO organization | Add SP to Organization Users |
      | "Permission denied" | SP not in project | Add SP to Project as Contributor |

      ```bash
      # Debug:
      python -m usf_fabric_cli.scripts.admin.utilities.debug_ado_access \
        --organization "acme-corp" \
        --project "FabricProjects"
      ```

      ## Error 3: "Branch not found"

      | Symptom | Cause | Solution |
      |---------|-------|----------|
      | Branch doesn't exist | Typo in `git_branch` | Check exact branch name in ADO |
      | Case sensitivity | `Main` vs `main` | Use exact case from repository |

      ```bash
      # List remote branches:
      git ls-remote --heads https://dev.azure.com/acme-corp/FabricProjects/_git/sales-analytics-repo
      ```

      ## Error 4: "Git sync conflict"

      | Symptom | Cause | Solution |
      |---------|-------|----------|
      | Sync fails | Local changes conflict with remote | Resolve in Fabric portal |
      | "Merge required" | Divergent histories | Pull changes, resolve, push |
    warnings:
      - Most Git integration failures are permission-related
      - "Always verify access with `debug_ado_access.py` before deployment"

  - id: github-config
    title: "Alternative: GitHub Configuration"
    type: config
    content: |
      For GitHub repositories (instead of Azure DevOps):

      ## Prerequisites

      - "GitHub Personal Access Token with `repo` scope"
      - "Token stored as `GITHUB_TOKEN` in `.env`"
    code:
      language: yaml
      filename: config/projects/acme_corp/sales_analytics.yaml
      content: |
        workspace:
          name: "acme-sales-analytics"
          display_name: "Acme Sales Analytics [{{ env }}]"
          capacity_id: "${FABRIC_CAPACITY_ID}"

          # GitHub Integration
          git_provider: "github"  # Specify provider explicitly
          git_repo: "https://github.com/acme-corp/sales-analytics"
          git_branch: "main"
          git_directory: "/fabric"
    tips:
      - "Ensure `GITHUB_TOKEN` is set in your `.env` file"
      - "Token needs `repo` scope for private repositories"
      - Public repositories work with read-only tokens

  - id: next-steps
    title: "ğŸ‰ Git Integration Complete!"
    type: info
    content: |
      You've mastered Git integration!

      ## What You've Accomplished

      - "âœ… Verified permissions with `debug_ado_access.py`"
      - "âœ… Initialized repositories with `init_ado_repo.py`"
      - "âœ… Used Docker for repo init with `make docker-init-repo`"
      - "âœ… Configured `git_repo` and `git_branch` in YAML"
      - âœ… Deployed workspaces with automatic Git connection
      - âœ… Verified connections in Fabric portal and via Git clone
      - âœ… Learned to troubleshoot common Git errors

      ## Command Quick Reference

      | Task | Command |
      |------|---------|
      | Debug ADO access | `python -m usf_fabric_cli.scripts.admin.utilities.debug_ado_access --organization "..." --project "..."` |
      | Initialize repo (local) | `python -m usf_fabric_cli.scripts.admin.utilities.init_ado_repo --organization "..." --project "..." --repository "..."` |
      | Initialize repo (Docker) | `make docker-init-repo org="..." project="..." repo="..."` |
      | Deploy with Git | `make deploy config=... env=dev` |
      | List remote branches | `git ls-remote --heads <repo-url>` |

      ## Recommended Next Steps

      1. **Previous:** [Feature Branch Workflows](#feature-branch-workflows) - Uses Git integration
      2. **Next:** [Troubleshooting](#troubleshooting) - Debug deployment issues
